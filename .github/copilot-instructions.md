# LENTERA Copilot Instructions

- **Architecture**: Monorepo with Flutter frontend(s) and FastAPI backend. Core spec and data flow live in [LENTERA_PROJECT_SPECIFICATION.txt](../LENTERA_PROJECT_SPECIFICATION.txt) and [GRAND_DESIGN.md](../GRAND_DESIGN.md). Supabase provides auth/storage/realtime; AI stack uses Ollama (LLM), ChromaDB (RAG), Whisper/TTS (placeholders).
- **Active app**: Prefer the richer Flutter app in [lentera_app/](../lentera_app); [client/](../client) is a minimal prototype. Mobile architecture is MVVM with Provider for state management and Supabase auth bootstrap in [lentera_app/lib/main.dart](../lentera_app/lib/main.dart).
- **Config**: Frontend constants come from [lentera_app/lib/core/constants/constants.dart](../lentera_app/lib/core/constants/constants.dart) using `String.fromEnvironment`; set `SUPABASE_URL`, `SUPABASE_ANON_KEY`, and `API_BASE_URL` at build time or replace the defaults. Backend reads `.env` via [server/app/core/config.py](../server/app/core/config.py) for `supabase_url`, `supabase_key`, `ollama_url`, `chroma_url`.
- **Backend services**: FastAPI entry is [server/app/main.py](../server/app/main.py) mounting routers for mood, doctors, booking, and trivia. Supabase client is created once in [server/app/core/supabase_client.py](../server/app/core/supabase_client.py). Trivia generation chains Chroma retrieval and Ollama in [server/app/services/ai_pipeline.py](../server/app/services/ai_pipeline.py); `stt.py` and `tts.py` are stubs.
- **Backend endpoints**: Mood creation expects multipart `json_data` (JSON string matching [server/app/models/mood.py](../server/app/models/mood.py)) plus optional `audio_file` in [server/app/api/v1/mood.py](../server/app/api/v1/mood.py); listing supports `user_id` and `date` filters. Doctors and bookings hit Supabase tables directly in [server/app/api/v1/doctors.py](../server/app/api/v1/doctors.py) and [server/app/api/v1/booking.py](../server/app/api/v1/booking.py). Trivia uses POST `/trivia/generate` with `mood_text` and optional model in [server/app/api/v1/trivia.py](../server/app/api/v1/trivia.py).
- **API mismatch to note**: Flutter `ApiService` currently posts `mood_score`, `journal_text`, `audio_file` form fields in [lentera_app/lib/core/services/api_service.dart](../lentera_app/lib/core/services/api_service.dart), but the backend expects `json_data` plus `audio_file`. Align payloads before wiring UI. `generateTrivia()` in the client calls `GET /trivia`, but backend exposes only POST `/trivia/generate` and `/trivia/submit`.
- **Auth/session flow**: Supabase is initialized before runApp in [lentera_app/lib/main.dart](../lentera_app/lib/main.dart). JWT is injected into Dio requests via an interceptor in `ApiService` ([lentera_app/lib/core/services/api_service.dart](../lentera_app/lib/core/services/api_service.dart)). Auth state and profiles are managed in [lentera_app/lib/providers/auth_provider.dart](../lentera_app/lib/providers/auth_provider.dart), creating a `users` row if missing.
- **Models**: Dart models mirror Supabase tables (e.g., [lentera_app/lib/models/mood_model.dart](../lentera_app/lib/models/mood_model.dart), [lentera_app/lib/models/psychologist_model.dart](../lentera_app/lib/models/psychologist_model.dart), [lentera_app/lib/models/user_model.dart](../lentera_app/lib/models/user_model.dart)). Pydantic schemas live beside endpoints (e.g., `MoodCreate`). Keep fields consistent with [DATABASE_SCHEMA.sql](../DATABASE_SCHEMA.sql) and Supabase RLS expectations.
- **Audio/Realtime**: Audio capture/playback handled by [lentera_app/lib/core/services/audio_service.dart](../lentera_app/lib/core/services/audio_service.dart) using `flutter_sound` and `permission_handler`. WebSocket utility is in [lentera_app/lib/core/services/socket_service.dart](../lentera_app/lib/core/services/socket_service.dart); backend WebSocket for voice calls is described in the spec but not yet implemented in code.
- **Styling & UX**: Material 3 with custom color seed and Inter typography set in [lentera_app/lib/main.dart](../lentera_app/lib/main.dart). Theme constants live in `AppConstants`. Follow tech rules in [TECH_STACK_AND_RULES.txt](../TECH_STACK_AND_RULES.txt): prefer Provider, const widgets, responsive layouts, and `AppTheme`/centralized colors.
- **Build/run (backend)**: `docker-compose up backend` brings up Python app with Ollama/Chroma (see [docker-compose.yml](../docker-compose.yml)). For local dev: `uvicorn app.main:app --host 0.0.0.0 --port 8080` from `server/` with `.env` configured; install deps from [server/requirements.txt](../server/requirements.txt).
- **Build/run (Flutter)**: From `lentera_app/`, run `flutter pub get` then `flutter run --dart-define=SUPABASE_URL=... --dart-define=SUPABASE_ANON_KEY=... --dart-define=API_BASE_URL=http://localhost:8080`. `analysis_options.yaml` exists; keep null safety and Provider patterns.
- **Data sources**: Supabase project URL/key sample is stored in [SUPABASE.txt](../SUPABASE.txt); treat as dev only. Storage bucket `mood-audio` is assumed by backend uploads. Ensure tables `users`, `mood_entries`, `psychologists`, `bookings` exist per [LENTERA_PROJECT_SPECIFICATION.txt](../LENTERA_PROJECT_SPECIFICATION.txt).
- **Product gaps/TODOs**: `chat_provider.dart`, `stt.py`, `tts.py`, and WebSocket call flow are placeholders. Handle error messaging via SnackBars per [TECH_STACK_AND_RULES.txt](../TECH_STACK_AND_RULES.txt). Align REST contracts and add tests before wiring new UI.

Let me know which sections need more detail or if additional workflows should be captured.
